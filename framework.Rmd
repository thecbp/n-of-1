---
title: "Simulation Framework"
author: "Christian Pascual"
output: html_document
---

```{r, message = F, warning = F }
library(tidyverse)
library(knitr)
```

# Doing The Simulations

![](./img/process.png)

# Creating The "Schedule" Of Subject Observations 

```{r}
# Function for creating backbone for data of an N-of-1 trial
create.backbone = function(order = c("A", "B"), s.freq = 1, 
                           p.length = 1, n.blocks = 1) {
  # Assumes that we will only be working with two treatments 
  
  # Parameters
  #   - order: the order that the treatments appear in
  #   - s.freq: sampling frequency, how many times a patient will be measured in a 
  #           given treatment period
  #   - p.length: period length
  #   - n.blocks: how many treatment blocks there are
  
  # Build out a block skeleton detailing the treatment schedule for the subject
  single.block = tibble(
    treatment = rep(order, each = s.freq * p.length)
  )
  
  # Append this data structure to itself repeatedly
  all.blocks = NULL
  for (i in 1:n.blocks) {
    all.blocks = bind_rows(all.blocks, single.block)
  }
  
  # Correctly label day of trial and treatment blocks
  all.blocks = all.blocks %>% 
    mutate(
      block = rep(1:n.blocks, each = s.freq * p.length * length(order)),
      day = rep(1:(n.blocks * p.length * length(order)), each = s.freq)
    )
  
  return(all.blocks)
}

# Confirming this works
# Sampling once a day, each treatment period is only one day, 3 blocks...
bb = create.backbone(order = c("A", "B", "B", "A"), 
                    s.freq = 1, p.length = 1, n.blocks = 3)
kable(head(bb))
```

With a schedule of treatments and periods down, we can start to model the carryover and wash-in effects. First, we need a proper representation of the different treatments.

# Treatment Objects 

There are three things that we need to know from a treatment:

- its actual effect on the outcome of interest
- the time needed for its effect to completely go away (carry over)
- the time needed for it to reach its full effect (wash in)

```{r}
# Function that captures decay transitions between two values
expdecay <- function(start, target, tau, delta_t) {
  # Parameters
  #   - start: the value we want to start at
  #   - target: the value we want to end up at after all delta_t
  #   - tau: scalar factor for how fast the decay happens (higher = faster)
  #   - delta_t: vector of numbers to calculate the transition vector
  
  start + (target - start) * exp(-delta_t / tau)
}

# Treatment that reduces outcome by 20 points, 2 days to ramp up, 3 days to die
trt.A = list(
  effect = -20,
  run = 2,
  carry = 3
)

# Treatment that is all placebo
trt.B = list(
  effect = 0,
  run = 0,
  carry = 0
)
```

```{r}

n = 10
tibble(
  x = 0:n,
  w = exponential_decay(1, 3, seq(0:n), 1),
  w1 = exponential_decay1(1, 3, seq(0:n), 2)
) %>% 
  ggplot(aes(x = x)) + 
  geom_point(aes(y = w),col = "green") +
  geom_point(aes(y = w1),col = "red") 
```





