---
title: "Design Parameters & Power, Accuracy"
output: html_document
---

```{r, message = F, warning = F }
library(tidyverse)
library(lme4)
source("sim.R")
```

# Key Questions

- How do different differences in the treatments themselves and baseline affect sample size?
- How do different differences in the treatments themselves affect power?

# Key Visualizations

- Number of samples vs Mean Power (subclassed by effect size)
- Number of samples vs Average Deviation of Patient Effect (subclassed by effect size)
- Process noise vs minimum sample size to reach power 0.80 (subclassed by effect size)
- Baseline drift vs average deviation of patient effect (subclassed by number of blocks)
- Run-in vs average deviation of patient effect (subclassed by effect difference)
- Carryover vs average deviation of patient effect (subclassed by effect difference)

# Number of Samples vs Mean Power (& Average Deviation of Effect)

## Fixed Parameters:

- $\mu_b = 0$
- $\sigma_b^2 = 5$
- Effect of Treatment A: -10
- Standard Deviation of Treament A: 1
- Run-in of A: $\tau = 2$
- Carryover of A: $\gamma = 2$
- Treatment B is placebo, standard deviation of B is 1
- Treatment order: A, B, B, A
- Sampling frequency: 1/day
- Period length: 20 days
- Number of blocks: 2

```{r}
trt.A = list(
  name = "A",
  effect = -10,
  sd = 0.01,
  run = 1,
  carry = 1
)

trt.B = list(
  name = "B",
  effect = 0,
  sd = 0.01,
  run = 0,
  carry = 0
)

test.trts = list(
  testing = c("A", "B"),
  A = trt.A,
  B = trt.B
)

# Visualization of the treatment profiles
test.data = simulate.trial(test.trts,
                           mu.b = 0, sd.b = 1, sd.o = 1, 
                           order = c("A", "B", "B", "A"), 
                           s.freq = 1, p.length = 20, n.blocks = 2,
                           baseline.type = "markov") %>% 
  mutate(
    A = ifelse(treatment == "A", 1, 0)
  )

test.data %>% 
  ggplot(aes(x = day)) + 
  geom_line(aes(y = baseline), color = "black") +
  geom_line(aes(y = obs), color = "gray") +
  geom_line(aes(y = A.eff), color = "red") +
  geom_line(aes(y = B.eff), color = "blue")
```

```{r}
# Example of model based on the data
nsamp.v.power.model = lmer(obs ~ A + (1|block), 
                           data = nsamp.v.power.data)
summary(nsamp.v.power.model)
```

```{r}
# Set constants for this simulation
nsamp.v.power.mu.b = 0
nsamp.v.power.sd.b = 1
nsamp.v.power.sd.o = 0.01
nsamp.v.power.order = c("A", "B", "B", "A")
nsamp.v.power.s.freq = 1
nsamp.v.power.n.blocks = 2

# Get a vector of candidate sample sizes 
p.length.vec = 1:20
A.eff.vec = seq(0.1, 1, by = 0.1)
N = 100

# Set up the placebo drug
trt.B = list(
  name = "B",
  effect = 0,
  sd = 0.01,
  run = 0,
  carry = 0
)

nsamp.v.power.results = NULL

for (pl in p.length.vec) {
  for (ae in A.eff.vec) {
    
    # Mock up the A treatment
    trt.A = list(
      name = "A",
      effect = ae,
      sd = 0.01,
      run = 1,
      carry = 1
    )
    
    trts = list(
      testing = c("A", "B"),
      A = trt.A, 
      B = trt.B
      )
    
    # Empty array to store results of all the simulations
    power.vec = integer(N)
    dev.vec = integer(N)
    
    for (i in 1:N) {
      # Create the simulated data set
      sim.data = simulate.trial(trts, 
                                mu.b = nsamp.v.power.mu.b, 
                                sd.b = nsamp.v.power.sd.b,
                                order = nsamp.v.power.order, 
                                s.freq = 1, 
                                p.length = pl, 
                                n.blocks = nsamp.v.power.n.blocks)
      
      sim.data = sim.data %>% 
        mutate(A = ifelse(treatment == "A", 1, 0))
      
      # Run the model on the data
      sim.model = lm(obs ~ A, data = sim.data)
      
      # Detect significance from the t-statistic
      power.vec[i] = summary(sim.model)$coefficients[2,4] <= 0.025
      
      # Calculate difference between estimated effect and the true effect 
      dev.vec[i] = ae - summary(sim.model)$coefficients[2,1]
    }
    
    # Record the results of these parameters
    res = tibble(
      n.samples = nrow(sim.data),
      effect.size = trt.A$effect,
      mean.power = mean(power.vec),
      mean.deviation = mean(dev.vec)
    )
    nsamp.v.power.results = bind_rows(nsamp.v.power.results, res)
  }
}

nsamp.v.power.results %>% 
  ggplot(aes(x = n.samples, y = mean.power, group = factor(effect.size), color = factor(effect.size))) +
  geom_line() +
  geom_hline(yintercept = 0.8, alpha = 0.5, color = "gray") +
  geom_hline(yintercept = 0.9, alpha = 0.5, color = "black") +
  labs(
    title = "Mean power based on sample size and effect size",
    x = "Sample size",
    y = "Mean Power"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "bottom",
    panel.background = element_rect(fill = "white")
    )
```

```{r}
nsamp.v.power.results %>% 
  ggplot(aes(x = n.samples, y = mean.deviation, group = factor(effect.size), color = factor(effect.size))) +
  geom_line() +
  labs(
    title = "Effect estimation based on sample size and effect size",
    x = "Sample size",
    y = "Average Deviation"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "bottom",
    panel.background = element_rect(fill = "white")
    )
```

# Baseline Noise vs Average Deviation (by number of blocks) (needs work)

What happens to the average deviation from the true effect if the baseline value has larger variance?

## Fixed Parameters:

- Length of study: 160 days
- $\mu_b = 0$
- Effect of Treatment A: -10
- Standard Deviation of Treament A: 1
- Run-in of A: $\tau = 2$
- Carryover of A: $\gamma = 2$
- Treatment B is placebo, standard deviation of B is 1
- Treatment order: A, B, B, A
- Sampling frequency: 1/day

```{r}
n.blocks = 2:5
sd.b.seq = 1:5
study.length = 240
N = 100
basenoise.v.deviation.mu.b = 0
basenoise.v.deviation.order = c("A", "B")
basenoise.v.deviation.s.freq = 1

# Set up the treatments
trt.A = list(
  name = "A",
  effect = -10,
  sd = 0.01,
  run = 2,
  carry = 2
)

# Set up the placebo drug
trt.B = list(
  name = "B",
  effect = 0,
  sd = 0.01,
  run = 0,
  carry = 0
)

basenoise.v.deviation.trts = list(
  testing = c("A", "B"),
  A = trt.A,
  B = trt.B
)

basenoise.v.deviation.results = NULL

for (n in n.blocks) {
  print(paste("Checking ", n, "block/s"))
  
  # Adjusting the period length to keep the study length constant
  adj.p.length = study.length / (2 * n)
  
  for (sdb in sd.b.seq) {
    
    dev.vec = integer(N)
    
    for (i in 1:N) {
      sim.data = simulate.trial(basenoise.v.deviation.trts, 
                                mu.b = basenoise.v.deviation.mu.b, 
                                sd.b = sdb,
                                order = basenoise.v.deviation.order, 
                                s.freq = basenoise.v.deviation.s.freq, 
                                p.length = adj.p.length, 
                                n.blocks = n,
                                baseline.type = "markov")
      
      sim.data = sim.data %>% 
        mutate(A = ifelse(treatment == "A", 1, 0))
      
      # Run the model on the data
      sim.model = lm(obs ~ A + factor(block), data = sim.data)
      
      
      # Calculate absolute difference from the true effect
      dev.vec[i] = trt.A$effect - summary(sim.model)$coefficients[2,1]
    }
    
    # Record the results of these parameters
    res = tibble(
      n.blocks = n,
      sd.b = sdb,
      avg.dev = mean(dev.vec),
    )
    basenoise.v.deviation.results = bind_rows(basenoise.v.deviation.results, res)
  }
}

basenoise.v.deviation.results = basenoise.v.deviation.results %>% 
  mutate(
    n.blocks = factor(n.blocks)
  )

basenoise.v.deviation.results %>% 
  ggplot(aes(x = sd.b, y = avg.dev, color = n.blocks, group = n.blocks)) +
  geom_line() +
  labs(
    title = "Effect estimation based on sample size and effect difference",
    x = "Baseline standard deviation",
    y = "Average deviation"
  )
```


# Run-in vs Effect Estimation

## Fixed Parameters:

- Baseline Level: $\mu_b = 0$
- Baseline Noise: $\sd_b = 1$
- Standard Deviation of Treament A: 1
- Carryover of A: $\gamma = 2$
- Treatment B is placebo, standard deviation of B is 1
- Treatment order: A, B, B, A
- Sampling frequency: 1/day
- Period length: 20 days
- Number of blocks: 4

## Change

- Effect of Treatment A will vary for effect size

```{r}
run.seq = seq(0.1, 10, length.out = 10)
eff.seq = c(0.1, 0.5, 1, 2, 5)
N = 100
process.v.minsamp.mu.b = 0
process.v.minsamp.sd.b = 1
process.v.minsamp.order = c("A", "B", "B", "A")
process.v.minsamp.p.length = 20
process.v.minsamp.s.freq = 1  
process.v.minsamp.n.blocks = 4

# Set up the placebo drug
trt.B = list(
  name = "B",
  effect = 0,
  sd = 1,
  run = 0,
  carry = 0
)

process.v.minsamp.results = NULL

for (r in run.seq) {
  for (ae in eff.seq) {
    
    # Set up the treatments
    trt.A = list(
      name = "A",
      effect = -1 * ae,
      sd = 1,
      run = r,
      carry = 2
    )
    
    process.v.minsamp.trts = list(
      testing = c("A", "B"),
      A = trt.A,
      B = trt.B
    )
    
    dev.vec = integer(N)
    
    for (i in 1:N) {
      sim.data = simulate.trial(process.v.minsamp.trts, 
                                mu.b = process.v.minsamp.mu.b, 
                                sd.b = process.v.minsamp.sd.b,
                                order = process.v.minsamp.order, 
                                s.freq = process.v.minsamp.s.freq, 
                                p.length = process.v.minsamp.p.length, 
                                n.blocks = process.v.minsamp.n.blocks,
                                baseline.type = "markov")
      
      sim.data = sim.data %>% 
        mutate(A = ifelse(treatment == "A", 1, 0))
      
      # Run the model on the data
      sim.model = lm(obs ~ A + factor(block), data = sim.data)
      
      
      # Calculate absolute difference from the true effect
      dev.vec[i] = trt.A$effect - summary(sim.model)$coefficients[2,1]
    }
    
    # Record the results of these parameters
    res = tibble(
      run = r,
      eff.size = ae,
      avg.dev = mean(dev.vec),
    )
    
    process.v.minsamp.results = bind_rows(process.v.minsamp.results, res)
    
  }
}

process.v.minsamp.results %>% 
  ggplot(aes(x = run, y = avg.dev, color = eff.size, group = eff.size)) +
  geom_line() +
  labs(
    title = "Effect estimation based on hypothetical run-in and effect difference",
    x = "Run in",
    y = "Average deviation"
  )
```


